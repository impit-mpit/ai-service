package usecase

import (
	"context"
	"encoding/json"
	"fmt"
	"neuro-most/ai-service/internal/adapters/vllm"
	"strings"
)

type (
	ChatUseCase interface {
		Execute(ctx context.Context, input ChatInput, stream func(string) error) error
	}

	ChatInput struct {
		Message string
	}

	ChatOutput struct {
		Response string
	}

	chatInteractor struct {
		vllm vllm.Vllm
	}
)

func NewChatUseCase(vllm vllm.Vllm) ChatUseCase {
	return &chatInteractor{vllm: vllm}
}

func (uc chatInteractor) Execute(ctx context.Context, input ChatInput, stream func(string) error) error {
	systemPrompt := "Your task is to answer the user's questions using only the information from the provided documents. Give two answers to each question: one with a list of relevant document identifiers and the second with the answer to the question itself, using documents with these identifiers."
	documents := []vllm.Document{
		{
			DocID:   0,
			Title:   "Аутизм у детей, общая информация",
			Content: "Аутизм у детей – болезнь, связанная с нарушением развития определенных психических функций, которая проявляется различными трудностями в социальном взаимодействии ребенка с окружающим миром, навязчивыми двигательными привычками и другими состояниями. Чаще всего заболевание диагностируют у малышей до 3–4 лет, но первые признаки отклонений в некоторых случаях можно заметить уже на первом году жизни. Общего лечения патологии не существует: специалисты разрабатывают индивидуальные методы коррекции аутизма у детей, отталкиваясь от состояния конкретного пациента. Обратите внимание: в детском отделении «СМ-Клиника» лечение аутизма не проводится, осуществляется общая поддержка и консультативная помощь в рамках назначенной ранее коррекции. В последние десятилетия число малышей с расстройством аутического спектра (РАС) значительно увеличилось. Врачи, работающие с такими ребятами, уверены, что причиной резкого прироста выявленных случаев послужила смена критериев обследования, развитие диагностических методик и более тщательное изучение проблемы. Степень проявления симптоматики при аутизме у детей может существенно отличаться: от полной неспособности контактировать с другими людьми до определенных «странностей» в поведении, таких как навязчивые движения, слишком узкий круг интересов или нестандартная манера речи. Более склонны к расстройству аутического спектра мальчики: они сталкиваются с заболеванием в общей сложности в два-три раза чаще, чем девочки. Ученые объясняют это лучшими коммуникативными способностями женского пола, из-за чего слабо выраженные формы аутизма могут быть попросту не замечены. Оценкой симптомов, поиском возможных причин возникновения аутизма у детей и коррекцией признаков РАС занимаются в комплексе нейропсихологи, детские неврологи, логопеды, психиатры, а также педагоги-дефектологи и социальные службы, если требуется."},
		{
			DocID:   1,
			Title:   "Классификация аутизма",
			Content: "На сегодняшний день разработано несколько вариантов описания детского аутизма, распределяющих патологию по видам с учетом определенных характеристик и признаков. Практикующие специалисты предпочитают пользоваться классификацией Никольской, которая позволяет сгруппировать состояния в зависимости от тяжести имеющихся признаков, ведущего синдрома и будущего прогноза. Такая классификация помогает более детально вникнуть в возможные причины РАС и подобрать коррекционное лечение, основываясь на индивидуальных особенностях детей с аутизмом. Она предполагает выделение четырех основных групп. Первая включает в себя самые значительные нарушения. Дети с такими формами заболевания не способны к социальным контактам, могут страдать от мутизма – состояния, при котором они умеют разговаривать и понимают окружающих, но не желают взаимодействовать. Для этой группы характерно постоянное повторение одних и тех же движений, отсутствие навыков самообслуживания, низкий уровень самоконтроля. Во вторую группу относят ребят, которые очень ярко и жестко реагируют на малейшие изменения в привычном распорядке, иногда даже сильной агрессией. При этом в окружении близких людей на фоне знакомой обстановки такие дети вполне способны к общению, открыты для диалога, хотя общаются в основном с помощью штампов и повторения сказанного другим человеком. Третья группа включает маленьких пациентов, у которых наблюдаются проблемы в общении с окружающим миром, но при этом они обладают высокими интеллектуальными способностями, стремятся к успеху и достижению цели. Проблема в том, что для получения результата такие ребята, в отличие от здоровых сверстников, не предпринимают никаких усилий. Дети с аутизмом этой степени сосредотачиваются на одном-двух интересах, изучая темы настолько углубленно, что уровень знаний можно оценить, как энциклопедический. В четвертую группу относят малышей, способных к произвольному и непроизвольному общению, установлению социальных контактов и взаимодействию, однако такие ребята быстро устают от общения, выполнения инструкций, не могут долго концентрировать внимание на одном занятии, стремятся изолировать себя от общества. Зачастую дети с таким уровнем РАС выглядят слишком робкими, застенчивыми, слывут «молчунами», однако при своевременной и грамотной коррекции показывают отличные результаты в учебе и творческой деятельности. Все характеристики детей с аутизмом невозможно уложить в какую-либо определенную схему, и даже с учетом классификаций необходимо в первую очередь отталкиваться от индивидуальных особенностей конкретного ребенка и окружающей его среды.",
		},
		{
			DocID:   2,
			Title:   "Причины развития аутизма",
			Content: "Достоверных причин возникновения патологии до сих пор не нашли. Существует несколько вполне обоснованных теорий, рассматривающих состояние, как следствие генетических отклонений или результат внутриутробного поражения плода. Ведущим направлением для изучения сегодня является версия о том, что существует определенный ген, предрасполагающий к аутизму. Ведутся исследования, которые уже показали: наличие гена существенно повышает риск возникновения РАС, особенно, если в семейном анамнезе имеются психоневрологические заболевания (эпилепсия, задержка речевого развития, заикание и т.д.). Другими вероятными причинами развития аутизма у детей считаются: структурные нарушения в головном мозге, проявляющиеся несоразмерным созреванием, диспропорцией определенных отделов, например, лобной доли, мозжечка; функциональные расстройства головного мозга, сопряженные с дефицитом внимания, ухудшением памяти, нарушениями разговорной функции и т.д.; сбои биохимических процессов, при которых наблюдается повышенная выработка одних веществ и недостаточный синтез других (в частности, в ходе исследований выявлено, что у детей с расстройствами аутического спектра имеется повышенный уровень серотонина, в то время как белки и глютен организмом не усваиваются или усваиваются плохо). Факторы, которые могут увеличить вероятность развития детского аутизма на фоне наличия гена предрасположенности и других основных причин, являются: тяжелые роды, протекавшие с осложнениями, гипоксией плода, маточными кровотечением и т.д.; инфекции, перенесенные ребенком во время внутриутробного периода развития; гестационный диабет беременных; нерациональное использование противоэпилептических препаратов во время беременности; депрессивные состояния будущей матери и другие психиатрические заболевания; наркотическая зависимость родительницы. Существует ошибочное мнение, что вакцинация от опасных инфекционных заболеваний также повышает риск развития аутизма из-за входящих в состав вакцины компонентов. Подобное мнение впервые было высказано в 90-ых года двадцатого века, но подтверждения оно до сих пор не нашло. Более того, проведенные за эти годы многократные исследования показали, что взаимосвязи между иммунизацией детей или будущих матерей и развитием аутизма нет.",
		},
		{
			DocID:   3,
			Title:   "Симптомы",
			Content: "Клинические проявления детского аутизма вариабельны: симптомы в отдельных случаях могут напоминать легкие формы депрессии, в других быть похожими на серьезные психические отклонения. При внимательном отношении к малышу самые ранние вестники патологии можно заметить уже в младенчестве. Первыми признаками аутизма у детей в раннем возрасте становятся: отказ от тактильных контактов – ребенок плачет, когда его берут на руки, отворачивается, изгибается, а успокаивается только после того, как его вернут в кроватку; пассивность в ответ на обращение родителей, отсутствие внимания, заинтересованности во время общения взрослых; резкая реакция на громкие звуки; равнодушие к ярким, гремящим, свистящим и пищащим игрушкам, которыми взрослые пытаются развлечь ребенка; безразличие к стандартным игрушкам, попытка играть неподходящими предметами. По мере взросления симптомами аутизма у детей могут послужить: отсутствие речи в возрасте 1,5–3 лет при наличии богатого словарного запаса и понимания разговора взрослых; эхолалия – неконтролируемое копирование и многократное повторение звуков, произнесенных другим человеком; персеверация – «застревание» на какой-либо фразе, слове, которую ребенок повторяет постоянно, или эмоции, или задании, при этом малыш неустанно обдумывает поглотившую его идею, но каких-либо шагов к достижению цели не делает; отказ от соблюдения игровых правил, указанных взрослыми или сверстниками, причем этот отказ не мотивирован личным решением малыша, его несогласием, он просто не понимает, зачем нужны какие-то установки и ограничения; трудности с восприятием эмоций других людей: дети с аутизмом не понимают, почему другие ребята смеются над какой-то фразой учителя или отчего плачет девочка, которую дернули за косичку; таким детям бывает недоступен юмор, сарказм, ирония; отсутствие реакции на собственное имя; нежелание смотреть прямо в глаза при общении, ответе или обращении, в том числе в ситуациях с родителями или другими близкими людьми; отсутствие страха, боязни при угрожающих жизни или здоровью обстоятельствах; истерики, бурные выражения эмоций при изменении привычного окружения, при появлении незнакомых людей и т.д.; беспокойный, тревожный сон с частыми пробуждениями. Ребята-аутисты предпочитают оставаться в одиночестве, не участвуют в коллективных занятиях, их трудно заставить что-то делать совместно с другими детьми. Они стараются уйти, спрятаться там, где их не будут трогать. Такие дети придумывают собственные игры, непонятные для сверстников, и постоянно в них играют. Со стороны окружающим людям движения ребенка-аутиста могут показаться странными, лишенными смысла. Во многих сериалах и фильмах, которые показывают жизнь людей с РАС, герои-аутисты представлены странными, но гениальными персонажами, которые избегают общения, обижают своей прямотой окружающих, но показывают великолепные результаты в профессиональной деятельности. В жизни, к сожалению, все не так: чаще всего у детей с аутизмом из-за нарушения функций коры больших полушарий головного мозга развивается умственная отсталость. Учеба дается им с трудом, они не в состоянии понять закономерности, выучить правила, вникнуть в решение задачи. Из-за проблем с учебой обостряется желание одиночества, обособленности. Такие дети могут проявлять неумеренную агрессию, которая чаще всего проецируется на близких или самого себя. Дети с аутизмом при неудачах могут кусать, резать себя, биться о посторонние предметы. Тем не менее ситуации, при которых аутисты обладают уникальными умственными способностями также встречаются. К сожалению, высокий интеллект не перекрывает другие проявления болезни: замкнутость, эмоциональную скудность, трудности с абстрактным мышлением, склонность к самобичеванию и т.д. Основной кризисный пик приходится на подростковый возраст: гормональные изменения в организме обостряют нарушения аутического спектра, ребенок, понимая, что он не такой, как все, замыкается еще больше. В редких случаях происходит обратный процесс, когда половое созревание помогает аутисту стать более спокойным, уравновешенным, что положительно в",
		},
		{
			DocID:   4,
			Title:   "Диагностика",
			Content: "Диагноз выставляется на основании длительного наблюдения за ребенком с признаками аутизма, при этом оценивается степень выраженности классической триады заболевания: дефицита социального взаимодействия; отсутствие или недостатка коммуникативных навыков; стереотипного поведения (навязчивые движения, привычки и т.д.). Для определения степени выраженности симптоматики родителям предлагают заполнить специальные опросники. Они помогают специалистам оценить поведение ребенка, выявить конкретные симптомы, характерные для той или иной группы заболевания, проанализировать имеющиеся показатели. В дальнейшем проводится комплекс инструментального обследования, в который входят: электроэнцефалография; ультразвуковое исследование головного мозга (возможно только при наличии незакрытого большого родничка); магнитно-резонансная томография мозга. В обязательном порядке проводится консультация сурдолога, офтальмолога, ЛОР-врача, а также логопеда и невролога.",
		},
		{
			DocID:   5,
			Title:   "Что такое аутизм?",
			Content: "Аутизм — диагноз, окружённый множеством мифов и домыслов. Одни считают, что аутизм — это следствие генных мутаций, другие верят, что дело в плохом воспитании или неудачно поставленной прививке. На самом деле, точно не ясно, из-за чего люди могут страдать аутизмом. Сегодня специалисты выделяют три основные причины заболевания: генные мутации, биохимические реакции в организме и нарушения в работе головного мозга. Раньше учёные считали, что аутизм — это ранняя аномалия, которая проходит после трёх лет. Но через какое-то время они заметили, что аутичные черты встречаются и у взрослых людей. Тогда учёные стали употреблять более широкое понятие — расстройство аутистического спектра (РАС). Признаков РАС существует множество, у одних людей они проявляются в виде двух-трёх странностей, у других — в виде комплекса нарушений. Часто аутизм путают с шизофренией и сенсорной алалией — это речевой диагноз, некоторыми симптомами напоминающий РАС (при алалии ребёнок не понимает обращённую речь и не говорит, из-за чего может сложиться впечатление, что он замкнут и не идёт на контакт). Различить эти диагнозы и правда сложно, особенно на ранних стадиях. Однако, чем раньше определить заболевание, тем легче потом будет адаптировать ребёнка к жизни. Поэтому очень важно не упустить момент и начать лечение, подходящее именно для конкретного случая. Так, например, шизофрению лечат медикаментозно. А при аутизме и РАС применяют комплексные регулярные занятия с коррекционными педагогами. Очевидно, что, если ребёнка с аутизмом лечить лекарственными препаратами, а с больными шизофренией просто проводить развивающие занятия, можно не только не добиться эффекта, но и навредить. Ведь эффективна лишь терапия, применяемая по назначению.",
		},
		{
			DocID:   6,
			Title:   "Документ ИППСУ: что это, как и зачем оформлять?",
			Content: `ИППСУ — индивидуальная программа предоставления социальных услуг. Это основной документ, по которому особенные дети получают бесплатную поддержку. В ИППСУ прописано, в какой помощи нуждается человек и в каком объёме она ему нужна. Нередко ИППСУ путают с индивидуальной программой реабилитации, абилитации (ИПРА). В чём разница? ИПРА — план медицинского и социального восстановления человека. Он составляется индивидуально и выдаётся после прохождения медико-социальной экспертизы (МСЭ) людям, получившим инвалидность. Программа помогает адаптироваться к жизни, вернуться к работе или найти её, компенсировать расходы — например, на протезирование или инвалидное кресло, бесплатно получить лекарства и другую помощь от государства. ИППСУ — документ, в котором перечислены виды соцуслуг, необходимых человеку. Здесь также указаны форма социального обслуживания, вид, объём, периодичность, сроки оказания услуг и список организаций, к которым рекомендовано обратиться. Именно ИППСУ нужна для того, чтобы получать помощь поставщика соцуслуг регулярно: заниматься со специалистами, консультироваться по разным вопросам и т. д. Как оформить ИППСУ на ребёнка? Для начала определите, положена ли ребёнку помощь по индивидуальной программе. Для этого оцените, подходит ли ваша ситуация под одно из оснований, перечисленных ниже (ст. 15. ФЗ № 442 от 28.12.2013 г.)? 1) полная или частичная утрата навыков самообслуживания и передвижения в силу заболевания, травмы, возраста или инвалидности; 2) наличие в семье ребёнка или взрослого с инвалидностью, который нуждается в постоянном постороннем уходе (позволяет получить ИППСУ родственникам); 3) наличие ребёнка или детей (в том числе находящихся под опекой/попечительством), испытывающих трудности в социальной адаптации; 4) отсутствие возможности ухода (в том числе временного) за человеком с инвалидностью и отсутствие попечения над ними; 5) внутрисемейный конфликт, в том числе с членами семьи, у которых есть с наркотическая/алкогольная зависимость, пристрастие к азартным играм или психические расстройства, а также насилие в семье; 6) отсутствие определенного места жительства, в том числе у человека младше 23 лет, завершившего пребывание в детском доме; 7) отсутствие работы и средств к существованию; 8) наличие иных обстоятельств, которые, по законодательству вашего региона, признаны ухудшающими или могут ухудшить условия жизнедеятельности человека. Способ № 1, если у ребёнка есть инвалидность (через соцзащиту): 1. Найдите управление социальной политики по вашему району 2. В соцполитике напишите заявление о признании ребёнка нуждающимся в соцобслуживании 3. К заявлению приложите: - паспорт или свидетельство о рождении ребенка, если вы родитель, а если опекун – акт органа опеки о назначении опекуна (в случае обращения с заявлением через представителя также нужна доверенность); - свидетельство о регистрации ребёнка по месту жительства с красной печатью или справка с места жительства с указанием состава семьи; - розовая справка МСЭ (медико-социальной экспертизы) о наличии инвалидности у ребёнка; - ИПРА (индивидуальная программа реабилитации или абилитации, также выдаётся на МСЭ), в которой прописаны рекомендации по оказанию помощи ребёнку; - СНИЛС ребёнка; - ваш паспорт; - справка №202н об отсутствии противопоказаний для получения помощи на дому, в полустационаре/стационаре (можно взять у врача, который наблюдает ребёнка, или заведующего медицинского учреждения), форма утверждена Приказом Минздрава РФ от 2 мая 2023 г.; - заключение ПМПК (психолого-медико-педагогической комиссии) - не обязательно, но тоже стоит взять в соцзащиту, т.к. там детально прописано, что необходимо ребёнку. Способ № 2, если у ребёнка нет инвалидности (через соцзащиту): 1. Найдите управление социальной политики по вашему району 2. В соцполитике напишите заявление о признании ребёнка нуждающимся в соцобслуживании 3. К заявлению приложите те же самые документы, что и в способе №1, кроме розовой справки МСЭ и ИПРА. Перед походом в отделение соцполитики, рекомендуем сделать копии всех документов, которые будете подавать, и принести их вместе с оригиналами. После того, как у вас приняли заявление, обязательно попросите поставить на копии входящий номер, дату приема и подпись сотрудника, который принял у вас документ – это подтвердит подачу, зафиксирует дату и сотрудника. После рассмотрения заявления министерство должно уведомить вас о решении в течение пяти рабочих дней и после этого разработать ИППСУ. Способ № 3, через портал «Госуслуги» (вне зависимости от наличия инвалидности): Перейдите на портал "Госуслуги". ! Обратите внимание, что на «Госуслугах», можно выбрать только одну форму обслуживания. Для получения помощи на дому и в полустационарной форме нужно сразу подать два заявления: в первом выбираете «полустационарную форму соц. обслуживания», а во втором «соц. обслуживание на дому». Далее следуйте инструкциям на экране. Примерный алгоритм: 1. Откройте приложение «Госуслуги» и зайдите в свой аккаунт; 2. Наберите в строке поиска на «Госуслугах»: «Признание гражданина нуждающимся в соц. обслуживании», нажмите «Далее»; 3. В графе «Выберите вариант предоставления услуги» отметьте «Полустационарная форма соц. обслуживания»; 4. Затем в графе «Причина признания гражданина нуждающимся в соц. обслуживании» выберите основания, актуальные для вашей семьи (ст. 15. ФЗ № 442 от 28.12.2013 г., список ранее по тексту); 5. Загрузите необходимые документы, которые подтверждают ухудшение условий жизни ребёнка; 6. Отметьте, кого нужно признать нуждающимся в соц. обслуживании (ребёнка); 7. Укажите вид представителя (родитель/опекун); 8. Заполните сведения о представителе ребенка (ФИО, СНИЛС, паспорт); 9. Укажите телефон и электронную почту; 10. Укажите адрес по месту жительства; 11. Впишите сведения о ребенке; 12. Загрузите справку из медучреждения о состоянии здоровья ребёнка; 13. Выберите «Территориальный отраслевой исполнительный орган государственной власти НАЗВАНИЕ РЕГИОНА – Управление социальной политики Министерства соц. политики НАЗВАНИЕ РЕГИОНА» в вашем районе. 14. Выберите «Получить дополнительно результат на бумажном носителе» и «Личное обращение в уполномоченный орган»; Для получения надомной формы проделайте то же самое, только в 3-м пункте выберите «Соц. обслуживание на дому». После отправки заявления через «Госуслуги» в течение пяти рабочих дней сотрудники соцполитики сообщат о своём решении и скажут, когда можно будет забрать ИППСУ. Если информации не поступит, позвоните в управление самостоятельно, и узнайте, когда прийти. С собой возьмите оригиналы и копии документов, которые прикрепляли через приложение и уточните, что может понадобиться ещё. С готовой ИППСУ вы можете обратиться к поставщикам соцуслуг и оформить помощь для ребёнка. Мы подберём вашему ребёнку тех специалистов, которые нужны именно ему и окажем квалифицированную эффективную помощь бесплатно.`,
		},
	}
	docsJson, err := json.Marshal(documents)
	if err != nil {
		return err
	}

	messages := []vllm.Message{
		{Role: "system", Content: systemPrompt},
		{Role: "documents", Content: string(docsJson)},
		{Role: "user", Content: input.Message},
	}

	var indexesBuilder strings.Builder
	indexes, err := uc.vllm.MakeVLLMRequest(messages, 0.0)
	if err != nil {
		return err
	}
	fmt.Println("Indexes:", indexes)

	messages = append(messages, vllm.Message{
		Role:    "assistant",
		Content: indexesBuilder.String(),
	})

	return uc.vllm.MakeVLLMStreamRequest(messages, 0.3, func(text string) error {
		fmt.Printf("Got chunk: %s\n", text) // Логируем каждый чанк
		return stream(text)
	})
}
